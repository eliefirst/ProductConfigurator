<?php
/**
 * ElielWeb OptionsProduct - Color Swatch Option Template (Hyva)
 * Template for displaying wire/thread colors as visual swatches
 *
 * @var $block \Magento\Framework\View\Element\Template
 * @var \Magento\Catalog\Model\Product\Option $option
 * @var \ElielWeb\ProductConfigurator\ViewModel\ProductOptions $optionsViewModel
 */

$option = $block->getData('option');
$product = $block->getData('product');
$optionsViewModel = $block->getData('options_view_model');

$optionId = $option->getOptionId();
$colorsData = $optionsViewModel->getWireColorsWithHex($option);

// Group colors by family for better organization
$colorFamilies = [
    'Fluorescent' => ['Fluo', 'Fluorescent', 'Flashy'],
    'Brown/Chocolate' => ['Chocolate', 'Brown', 'Cocoa', 'Loam', 'Rust'],
    'Pink/Purple' => ['Pink', 'Rose', 'Fushia', 'Orchid', 'Peony', 'Raspberry', 'Candy', 'Lilac', 'Purple', 'Violet', 'Lavender', 'Mauve'],
    'Blue' => ['Blue', 'Ocean', 'Caribbean', 'Navy', 'Baltic', 'Lagoon'],
    'Black/Gray' => ['Black', 'Licorice', 'Anthracite', 'Gray', 'Grey', 'Metal'],
    'Green' => ['Green', 'Olive', 'Jade', 'Forest', 'Leaf', 'Emerald', 'Lime', 'Khaki', 'Duck'],
    'Beige/Neutral' => ['Beige', 'Taupe', 'Greige', 'Pearl', 'Cream', 'White', 'Champagne', 'Biscuit', 'Wheat'],
    'Orange/Red' => ['Orange', 'Red', 'Salmon', 'Pumpkin', 'Carrot', 'Poppy', 'Cherry', 'Pomegranate'],
    'Other' => []
];

$groupedColors = [];
foreach ($colorsData as $color) {
    $assigned = false;
    foreach ($colorFamilies as $family => $keywords) {
        foreach ($keywords as $keyword) {
            if (stripos($color['name'], $keyword) !== false) {
                $groupedColors[$family][] = $color;
                $assigned = true;
                break 2;
            }
        }
    }
    if (!$assigned) {
        $groupedColors['Other'][] = $color;
    }
}
?>

<div class="color-swatch-options wire-color-selector"
     x-data="{
         selectedColor: null,
         hoveredColor: null,
         showAllColors: false
     }"
     role="radiogroup"
     aria-labelledby="option-label-<?= $escaper->escapeHtmlAttr($optionId) ?>">

    <!-- Hidden input for form submission -->
    <input type="hidden"
           name="options[<?= $escaper->escapeHtmlAttr($optionId) ?>]"
           x-model="selectedColor"
           <?= $option->getIsRequire() ? 'required' : '' ?>>

    <!-- Color family groups -->
    <?php foreach ($groupedColors as $family => $familyColors): ?>
        <?php if (!empty($familyColors)): ?>
            <div class="color-family-group"
                 x-show="showAllColors || '<?= $escaper->escapeJs($family) ?>' === 'Pink/Purple' || '<?= $escaper->escapeJs($family) ?>' === 'Blue' || '<?= $escaper->escapeJs($family) ?>' === 'Black/Gray'">
                <h4 class="family-title"><?= $escaper->escapeHtml(__($family)) ?></h4>

                <div class="color-swatches-grid">
                    <?php foreach ($familyColors as $color): ?>
                        <?php
                        $colorId = $color['id'];
                        $colorName = $color['name'];
                        $colorHex = $color['hex'];
                        $price = $color['price'];
                        $priceType = $color['price_type'];
                        $inputId = 'color_' . $optionId . '_' . $colorId;

                        // Determine if color is light (for border visibility)
                        $rgb = sscanf($colorHex, "#%02x%02x%02x");
                        $luminance = ($rgb[0] * 0.299 + $rgb[1] * 0.587 + $rgb[2] * 0.114) / 255;
                        $isLight = $luminance > 0.8;
                        ?>

                        <div class="color-swatch-item"
                             @click="selectedColor = '<?= $escaper->escapeJs($colorId) ?>';
                                     selectOption(<?= (int)$optionId ?>, <?= (int)$colorId ?>, <?= (float)$price ?>)"
                             @mouseenter="hoveredColor = '<?= $escaper->escapeJs($colorId) ?>'"
                             @mouseleave="hoveredColor = null"
                             :class="{ 'selected': selectedColor === '<?= $escaper->escapeJs($colorId) ?>' }">

                            <div class="color-swatch <?= $isLight ? 'light-color' : '' ?>"
                                 style="background-color: <?= $escaper->escapeHtmlAttr($colorHex) ?>;"
                                 title="<?= $escaper->escapeHtmlAttr($colorName) ?>">

                                <!-- Checkmark for selected color -->
                                <svg class="check-icon"
                                     x-show="selectedColor === '<?= $escaper->escapeJs($colorId) ?>'"
                                     xmlns="http://www.w3.org/2000/svg"
                                     viewBox="0 0 24 24"
                                     fill="none"
                                     stroke="currentColor"
                                     stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>

                            <!-- Color name tooltip -->
                            <div class="color-tooltip"
                                 x-show="hoveredColor === '<?= $escaper->escapeJs($colorId) ?>' || selectedColor === '<?= $escaper->escapeJs($colorId) ?>'">
                                <span class="color-name"><?= $escaper->escapeHtml($colorName) ?></span>
                                <?php if ($price != 0): ?>
                                    <span class="color-price">
                                        <?php if ($priceType === 'percent'): ?>
                                            (<?= $price > 0 ? '+' : '' ?><?= $escaper->escapeHtml($price) ?>%)
                                        <?php else: ?>
                                            (<?= $price > 0 ? '+' : '' ?><?= $escaper->escapeHtml($block->formatPrice($price)) ?>)
                                        <?php endif; ?>
                                    </span>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        <?php endif; ?>
    <?php endforeach; ?>

    <!-- Show more/less button -->
    <button type="button"
            class="show-all-colors-btn"
            @click="showAllColors = !showAllColors"
            x-text="showAllColors ? '<?= $escaper->escapeJs(__('Show Less Colors')) ?>' : '<?= $escaper->escapeJs(__('Show All Colors')) ?>'">
    </button>
</div>

<style>
.wire-color-selector {
    margin: 1rem 0;
}

.color-family-group {
    margin-bottom: 2rem;
}

.family-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.color-swatches-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 0.75rem;
    max-width: 100%;
}

.color-swatch-item {
    position: relative;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.color-swatch-item:hover {
    transform: translateY(-2px);
}

.color-swatch {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid transparent;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.color-swatch.light-color {
    border: 2px solid #ddd;
}

.color-swatch-item:hover .color-swatch {
    border-color: #1a73e8;
    box-shadow: 0 4px 8px rgba(26, 115, 232, 0.3);
}

.color-swatch-item.selected .color-swatch {
    border: 3px solid #1a73e8;
    box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    transform: scale(1.1);
}

.check-icon {
    width: 20px;
    height: 20px;
    color: white;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
}

.color-swatch.light-color .check-icon {
    color: #1a73e8;
    filter: none;
}

.color-tooltip {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: 0.5rem;
    background-color: #333;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 10;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.color-tooltip::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-bottom-color: #333;
}

.color-name {
    display: block;
    font-weight: 600;
}

.color-price {
    display: block;
    font-size: 0.7rem;
    opacity: 0.9;
    margin-top: 0.125rem;
}

.show-all-colors-btn {
    margin-top: 1rem;
    padding: 0.5rem 1.5rem;
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: #333;
    transition: all 0.2s ease;
}

.show-all-colors-btn:hover {
    background-color: #1a73e8;
    border-color: #1a73e8;
    color: white;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .color-swatches-grid {
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 0.5rem;
    }

    .color-swatch {
        width: 40px;
        height: 40px;
    }
}

@media (max-width: 480px) {
    .color-swatches-grid {
        grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
    }

    .color-swatch {
        width: 35px;
        height: 35px;
    }
}
</style>
